const Order = require("../schemas/orderSchema");
const mongoose = require("mongoose");
const Vegetable = require("../schemas/vegetableSchema");

exports.getTopVegetablesByFarmer = async (req, res) => {
  try {
    const { farmerId } = req.params;

    if (!farmerId) {
      return res.status(400).json({ message: "Missing farmerId" });
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ 2024
    const startOfYear = new Date("2024-01-01T00:00:00.000Z");
    const endOfYear = new Date("2024-12-31T23:59:59.999Z");

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• order ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏™‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ orderDate ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏µ 2024
    const orders = await Order.find({
      "details.farmerId": farmerId,
      orderDate: { $gte: startOfYear, $lte: endOfYear },
    })
      .populate("vegetable", "name imageUrl") // ‚úÖ ‡∏î‡∏∂‡∏á imageUrl ‡∏î‡πâ‡∏ß‡∏¢
      .lean();

    if (!orders.length) {
      return res
        .status(404)
        .json({ message: "No orders found for this farmer in 2024" });
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏±‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î
    const vegetableMap = new Map();

    orders.forEach((order) => {
      order.details.forEach((detail) => {
        if (detail.farmerId.toString() === farmerId) {
          const vegName = order.vegetable.name;
          const vegImage = order.vegetable.imageUrl; // ‚úÖ ‡∏î‡∏∂‡∏á URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ú‡∏±‡∏Å
          const quantity = detail.quantityKg;

          if (vegetableMap.has(vegName)) {
            let existing = vegetableMap.get(vegName);
            vegetableMap.set(vegName, {
              quantity: existing.quantity + quantity,
              imageUrl: vegImage, // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö imageUrl
            });
          } else {
            vegetableMap.set(vegName, {
              quantity,
              imageUrl: vegImage, // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö imageUrl
            });
          }
        }
      });
    });

    // ‡πÅ‡∏õ‡∏•‡∏á Map ‡πÄ‡∏õ‡πá‡∏ô Array ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°
    const sortedVegetables = [...vegetableMap.entries()]
      .sort((a, b) => b[1].quantity - a[1].quantity)
      .slice(0, 3) // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
      .map(([name, data]) => ({
        name,
        quantity: data.quantity,
        imageUrl: data.imageUrl || "/uploads/default.png", // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ ‡πÉ‡∏ä‡πâ default
      }));

    res.status(200).json({
      message: "success",
      farmerId,
      topVegetables: sortedVegetables,
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error" });
  }
};

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Order ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
exports.getAllOrder = async (req, res) => {
  try {
    const {
      search, // ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠ ObjectId
      season, // ‡∏§‡∏î‡∏π
      farmerId, // ‡πÑ‡∏≠‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏™‡∏ß‡∏ô
      quantity, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
      actualKg, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á
      status, // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á
      orderDate, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å
    } = req.body;

    const limit = parseInt(req.query.limit) || 0; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á

    const filter = {};
    if (season) filter.season = season;

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤ search ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å
    if (search) {
      if (mongoose.Types.ObjectId.isValid(search)) {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ObjectId ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ ObjectId
        filter.vegetable = search;
      } else {
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠
        const vegetable = await Vegetable.findOne({
          name: new RegExp(search, "i"),
        });
        if (vegetable) {
          filter.vegetable = vegetable._id; // ‡πÉ‡∏ä‡πâ ObjectId ‡∏Ç‡∏≠‡∏á‡∏ú‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö
        } else {
          return res.status(404).json({ message: "Vegetable not found" });
        }
      }
    }

    if (orderDate) {
      const parsedDate = new Date(orderDate);
      if (!isNaN(parsedDate)) {
        const startOfDay = new Date(parsedDate.setUTCHours(0, 0, 0, 0));
        const endOfDay = new Date(parsedDate.setUTCHours(23, 59, 59, 999));
        filter.orderDate = { $gte: startOfDay, $lt: endOfDay };
      } else {
        return res.status(400).json({ message: "Invalid orderDate format" });
      }
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô details
    if (farmerId || quantity || actualKg || status) {
      filter.details = { $elemMatch: {} };
      if (farmerId) filter.details.$elemMatch.farmerId = farmerId;
      if (quantity)
        filter.details.$elemMatch.quantityKg = { $gte: parseFloat(quantity) };
      if (actualKg)
        filter.details.$elemMatch["delivery.actualKg"] = {
          $gte: parseFloat(actualKg),
        };
      if (status) filter.details.$elemMatch["delivery.status"] = status;
    }

    const orders = await Order.find(filter)
      .populate("vegetable", "name") // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏±‡∏Å
      .populate("details.farmerId", "firstName lastName") // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£
      .limit(limit); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô

    const totalOrders = await Order.countDocuments(filter);

    res.status(200).json({
      message: "success",
      totalOrders,
      pageSize: orders.length,
      data: orders,
    });
  } catch (error) {
    res.status(500).json({
      message: error.message,
    });
  }
};

exports.getOrderById = async (req, res) => {
  try {
    const { orderId } = req.params;

    if (!orderId) {
      return res.status(400).json({ message: "Missing orderId" });
    }

    const order = await Order.findById(orderId)
      .populate("vegetable", "name")
      .populate("details.farmerId", "firstName lastName");

    if (!order) {
      return res.status(404).json({ message: "Order not found" });
    }

    res.status(200).json({
      message: "success",
      order,
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error" });
  }
};

// ‡∏™‡∏£‡πâ‡∏≤‡∏á Order
exports.createOrder = async (req, res) => {
  try {
    const {
      orderDate, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å
      vegetableId, // ObjectId ‡∏Ç‡∏≠‡∏á‡∏ú‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á
      season, // ‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å
      details, // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)
    } = req.body;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
    if (
      !orderDate ||
      !vegetableId ||
      !season ||
      !details ||
      details.length === 0
    ) {
      return res.status(400).json({ message: "Missing required fields" });
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Order
    const newOrder = new Order({
      orderDate,
      vegetable: vegetableId,
      season,
      details,
    });

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Order ‡∏•‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    await newOrder.save();

    res.status(201).json({
      message: "Order created successfully",
      order: newOrder,
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error" });
  }
};

// update Order ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
exports.updateOrder = async (req, res) => {
  try {
    const { orderId } = req.params;
    const updateData = req.body;

    if (!orderId) {
      return res.status(400).json({ message: "Missing orderId" });
    }

    const order = await Order.findById(orderId);
    if (!order) {
      return res.status(404).json({ message: "Order not found" });
    }

    let isUpdated = false;

    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    if (updateData.orderDate !== undefined) {
      order.orderDate = updateData.orderDate;
      isUpdated = true;
    }
    if (updateData.vegetable !== undefined) {
      order.vegetable = updateData.vegetable;
      isUpdated = true;
    }
    if (updateData.season !== undefined) {
      order.season = updateData.season;
      isUpdated = true;
    }

    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï `details` ‡πÅ‡∏ö‡∏ö‡∏•‡∏∂‡∏Å
    if (updateData.details && Array.isArray(updateData.details)) {
      updateData.details.forEach((updateDetail) => {
        const existingDetail = order.details.find(
          (d) => d._id.toString() === updateDetail._id
        );

        if (existingDetail) {
          if (updateDetail.quantityKg !== undefined) {
            existingDetail.quantityKg = updateDetail.quantityKg;
            isUpdated = true;
          }
          if (updateDetail.delivery) {
            if (updateDetail.delivery.actualKg !== undefined) {
              existingDetail.delivery.actualKg = updateDetail.delivery.actualKg;
              isUpdated = true;
            }
            if (updateDetail.delivery.deliveredDate !== undefined) {
              existingDetail.delivery.deliveredDate =
                updateDetail.delivery.deliveredDate;
              isUpdated = true;
            }
            if (updateDetail.delivery.status !== undefined) {
              existingDetail.delivery.status = updateDetail.delivery.status;
              isUpdated = true;
            }
          }
        }
      });

      order.markModified("details"); // üî• ‡∏ö‡∏≠‡∏Å Mongoose ‡∏ß‡πà‡∏≤ details ‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    }

    if (!isUpdated) {
      return res.status(400).json({ message: "No updates were made" });
    }

    order.updatedAt = new Date();
    await order.save();

    res.status(200).json({
      message: "Order updated successfully",
      order,
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error" });
  }
};

exports.deleteOrder = async (req, res) => {
  try {
    const { orderId } = req.params; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ orderId ‡∏à‡∏≤‡∏Å URL

    console.log(orderId);
    if (!orderId) {
      return res.status(400).json({ message: "Missing orderId" });
    }

    // ‡∏•‡∏ö Order ‡∏ó‡∏µ‡πà‡∏°‡∏µ orderId ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
    const deletedOrder = await Order.findByIdAndDelete(orderId);

    if (!deletedOrder) {
      return res.status(404).json({ message: "Order not found" });
    }

    res.status(200).json({
      message: "Order deleted successfully",
      order: deletedOrder,
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Server error" });
  }
};

// exports.Confarm = async (req, res) => {
//   try {
//     const { orderId } = req.params;
//     const updateData = req.body;

//     if (!orderId) {
//       return res.status(400).json({ message: "Missing orderId" });
//     }

//     const order = await Order.findById(orderId);
//     if (!order) {
//       return res.status(404).json({ message: "Order not found" });
//     }

//     let isUpdated = false;

//     // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
//     if (updateData.orderDate !== undefined) {
//       order.orderDate = updateData.orderDate;
//       isUpdated = true;
//     }
//     if (updateData.vegetable !== undefined) {
//       order.vegetable = updateData.vegetable;
//       isUpdated = true;
//     }
//     if (updateData.season !== undefined) {
//       order.season = updateData.season;
//       isUpdated = true;
//     }

//     // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï `details` ‡πÅ‡∏ö‡∏ö‡∏•‡∏∂‡∏Å
//     if (updateData.details && Array.isArray(updateData.details)) {
//       updateData.details.forEach((updateDetail) => {
//         const existingDetail = order.details.find(
//           (d) => d._id.toString() === updateDetail._id
//         );

//         if (existingDetail) {
//           if (updateDetail.quantityKg !== undefined) {
//             existingDetail.quantityKg = updateDetail.quantityKg;
//             isUpdated = true;
//           }
//           if (updateDetail.delivery) {
//             if (updateDetail.delivery.actualKg !== undefined) {
//               existingDetail.delivery.actualKg = updateDetail.delivery.actualKg;
//               isUpdated = true;
//             }
//             if (updateDetail.delivery.deliveredDate !== undefined) {
//               existingDetail.delivery.deliveredDate =
//                 updateDetail.delivery.deliveredDate;
//               isUpdated = true;
//             }
//             if (updateDetail.delivery.status !== undefined) {
//               existingDetail.delivery.status = updateDetail.delivery.status;
//               isUpdated = true;
//             }
//           }
//         }
//       });

//       order.markModified("details"); // üî• ‡∏ö‡∏≠‡∏Å Mongoose ‡∏ß‡πà‡∏≤ details ‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
//     }

//     if (!isUpdated) {
//       return res.status(400).json({ message: "No updates were made" });
//     }

//     order.updatedAt = new Date();
//     await order.save();

//     res.status(200).json({
//       message: "Order updated successfully",
//       order,
//     });
//   } catch (error) {
//     console.error(error);
//     res.status(500).json({ message: "Server error" });
//   }
// };
